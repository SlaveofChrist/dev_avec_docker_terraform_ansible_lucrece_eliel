---
- name: Déploiement Application FullStack (Frontend + API + DB + Redis)
  hosts: app_hosts
  become: true
  vars:
    project_dir: "/home/ubuntu/app-fullstack"
    public_ip: "{{ ansible_host }}"

  tasks:
    # 1. Installation Docker et dépendances
    - name: Installation des paquets
      apt:
        update_cache: yes
        name:
          - docker.io
          - docker-compose-v2
          - git
          - python3-pip
          - python3-passlib
        state: present

    - name: Ajout user au groupe docker
      user:
        name: ubuntu
        groups: docker
        append: yes

    # 2. Création des dossiers de projet
    - name: Création des dossiers du projet
      file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - "{{ project_dir }}"
        - "{{ project_dir }}/app"
        - "{{ project_dir }}/frontend"
        - "{{ project_dir }}/sqlfiles"

    # 3. Copie du docker-compose.yml
    - name: Copie du docker-compose.yml
      template:
        src: docker-compose.yml
        dest: "{{ project_dir }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # 4. Copie du Dockerfile
    - name: Copie du python.Dockerfile
      template:
        src: python.Dockerfile
        dest: "{{ project_dir }}/python.Dockerfile"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # 5. Copie de l'application Python
    - name: Copie de l'application Python (app/main.py)
      template:
        src: app/main.py
        dest: "{{ project_dir }}/app/main.py"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # 6. Copie des requirements
    - name: Copie de requirements.txt
      template:
        src: requirements.txt
        dest: "{{ project_dir }}/requirements.txt"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # 7. Copie du frontend
    - name: Copie du frontend (index.html)
      template:
        src: frontend/index.html
        dest: "{{ project_dir }}/frontend/index.html"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    # 8. Copie des fichiers de migration SQL
    - name: Copie des fichiers SQL de migration
      template:
        src: "sqlfiles/{{ item }}"
        dest: "{{ project_dir }}/sqlfiles/{{ item }}"
        owner: ubuntu
        group: ubuntu
        mode: '0644'
      loop:
        - migration-v001.sql
        - migration-v002.sql
        - migration-v003.sql

    # 9. Arrêt de la stack actuelle (s'il existe)
    - name: Arrêt de la stack existante
      command: docker compose down
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: true

    # 10. Build et démarrage de la stack
    - name: Build et démarrage de la stack Docker Compose
      command: docker compose up --build --force-recreate -d
      args:
        chdir: "{{ project_dir }}"

    # 11. Vérification du statut des conteneurs
    - name: Récupération du statut des conteneurs
      command: docker compose ps
      args:
        chdir: "{{ project_dir }}"
      register: compose_ps_output

    - name: Affichage du statut final dans la console
      debug:
        msg: "{{ compose_ps_output.stdout_lines }}"

    # 12. Affichage des URLs d'accès
    - name: Affichage des informations de déploiement
      debug:
        msg:
          - "=========================================="
          - "Application déployée avec succès!"
          - "=========================================="
          - "Frontend: http://{{ public_ip }}:8080"
          - "API: http://{{ public_ip }}:8000"
          - "PostgreSQL: {{ public_ip }}:5432"
          - "Redis: {{ public_ip }}:6379"
          - "=========================================="
