name: Deploy Infrastructure & Application

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'main.tf'
      - 'playbook.yml'
      - 'inventory.ini'
      - 'docker-compose.yml'
      - 'python.Dockerfile'
      - 'requirements.txt'
      - 'app/**'
      - 'frontend/**'
      - 'sqlfiles/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Permet de déclencher manuellement

env:
  AWS_REGION: eu-west-3
  TF_VERSION: "1.2"

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest
    outputs:
      instance_ip: ${{ steps.tf_output.outputs.instance_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Clean Up Existing AWS Resources
        run: |
          echo "Nettoyage des ressources AWS existantes..."
          
          # Supprimer la clé SSH si elle existe
          if aws ec2 describe-key-pairs --key-names app-key-terraform 2>/dev/null | grep -q "app-key-terraform"; then
            echo "Suppression de la clé SSH: app-key-terraform"
            aws ec2 delete-key-pair --key-name app-key-terraform || true
          fi
          
          # Supprimer le Security Group si il existe
          SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=app-sg-fullstack" --query 'SecurityGroups[0].GroupId' --output text 2>/dev/null)
          if [ "$SG_ID" != "None" ] && [ ! -z "$SG_ID" ]; then
            echo "Suppression du Security Group: $SG_ID"
            aws ec2 delete-security-group --group-id $SG_ID || true
            sleep 5
          fi
          
          echo "Nettoyage terminé."
        continue-on-error: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (Check State)
        run: terraform init
        working-directory: ${{ github.workspace }}
        continue-on-error: true

      - name: Destroy Existing Resources
        run: |
          if [ -f terraform.tfstate ]; then
            echo "État Terraform trouvé. Destruction des ressources existantes..."
            terraform destroy -auto-approve
          else
            echo "Aucun état Terraform existant. Pas de destruction nécessaire."
          fi
        working-directory: ${{ github.workspace }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ github.workspace }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ github.workspace }}

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: ${{ github.workspace }}

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ github.workspace }}

      - name: Get Instance IP
        id: tf_output
        run: |
          INSTANCE_IP=$(terraform output -raw instance_ip 2>/dev/null)
          echo "instance_ip=${INSTANCE_IP}" >> $GITHUB_OUTPUT
          echo "Instance IP: ${INSTANCE_IP}"
        working-directory: ${{ github.workspace }}
        env:
          TF_LOG: off

      - name: Save Terraform State (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: terraform.tfstate

  ansible:
    name: Ansible Deploy
    runs-on: ubuntu-latest
    needs: terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible paramiko

      - name: Update inventory.ini with Instance IP
        run: |
          INSTANCE_IP=${{ needs.terraform.outputs.instance_ip }}
          sed -i "s/^# Cette IP sera remplacée par la sortie de main.tf$/# Instance IP: $INSTANCE_IP/" inventory.ini
          sed -i "s/^13\.39\.13\.141$/$INSTANCE_IP/" inventory.ini
          cat inventory.ini

      - name: Download SSH Key from Terraform
        run: |
          ls -la app-key-terraform.pem 2>/dev/null || echo "SSH key will be created by terraform"

      - name: Set SSH Key Permissions
        run: |
          if [ -f app-key-terraform.pem ]; then
            chmod 600 app-key-terraform.pem
          fi

      - name: Update SSH Config
        run: |
          mkdir -p ~/.ssh
          echo "Host *" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config
          echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
          chmod 600 ~/.ssh/config

      - name: Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini playbook.yml -v
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'

      - name: Verify Deployment
        run: |
          INSTANCE_IP=${{ needs.terraform.outputs.instance_ip }}
          echo ""
          echo "=========================================="
          echo "Déploiement terminé!"
          echo "=========================================="
          echo "Frontend:  http://$INSTANCE_IP:8080"
          echo "API:       http://$INSTANCE_IP:8000"
          echo "PostgreSQL: $INSTANCE_IP:5432"
          echo "Redis:     $INSTANCE_IP:6379"
          echo "=========================================="

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [terraform, ansible]
    if: always()
    
    steps:
      - name: Check Deployment Status
        run: |
          if [ "${{ needs.terraform.result }}" == "success" ] && [ "${{ needs.ansible.result }}" == "success" ]; then
            echo "✅ Deployment successful!"
            echo "Instance IP: ${{ needs.terraform.outputs.instance_ip }}"
            exit 0
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
